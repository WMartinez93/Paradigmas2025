:- dynamic(conductor/5).
%interseccion(Calle1, Calle2, X, Y).
interseccion('Av_Caballero', 'Av_Francia', 0, 0).
interseccion('Av_Caballero', 'Antequera', 0, 1).
interseccion('Av_Caballero', 'Artigas', 0, 2).
interseccion('Av_Caballero', 'J_L_Mallorquin', 0, 3).
interseccion('Av_Caballero', 'Mcal_Estigarribia', 0, 4).
interseccion('Av_Caballero', 'C_A_Lopez', 0, 5).
interseccion('Av_Caballero', 'Lomas_Valentinas', 0, 6).
interseccion('Av_Caballero', 'Independencia_Nacional', 0, 7).
interseccion('Av_Caballero', 'Honorio_Gonzalez', 0, 8).
interseccion('Av_Caballero', 'Av_Irrazabal', 0, 9).
interseccion('Constitucion_Nacional', 'Av_Francia', 1, 0).
interseccion('Constitucion_Nacional', 'Antequera', 1, 1).
interseccion('Constitucion_Nacional', 'Artigas', 1, 2).
interseccion('Constitucion_Nacional', 'J_L_Mallorquin', 1, 3).
interseccion('Constitucion_Nacional', 'Mcal_Estigarribia', 1, 4).
interseccion('Constitucion_Nacional', 'C_A_Lopez', 1, 5).
interseccion('Constitucion_Nacional', 'Lomas_Valentinas', 1, 6).
interseccion('Constitucion_Nacional', 'Independencia_Nacional', 1, 7).
interseccion('Constitucion_Nacional', 'Honorio_Gonzalez', 1, 8).
interseccion('Constitucion_Nacional', 'Av_Irrazabal', 1, 9).
interseccion('25_de_Mayo', 'Av_Francia', 2, 0).
interseccion('25_de_Mayo', 'Antequera', 2, 1).
interseccion('25_de_Mayo', 'Artigas', 2, 2).
interseccion('25_de_Mayo', 'J_L_Mallorquin', 2, 3).
interseccion('25_de_Mayo', 'Mcal_Estigarribia', 2, 4).
interseccion('25_de_Mayo', 'C_A_Lopez', 2, 5).
interseccion('25_de_Mayo', 'Lomas_Valentinas', 2, 6).
interseccion('25_de_Mayo', 'Independencia_Nacional', 2, 7).
interseccion('25_de_Mayo', 'Honorio_Gonzalez', 2, 8).
interseccion('25_de_Mayo', 'Av_Irrazabal', 2, 9).
interseccion('Villarrica', 'Av_Francia', 3, 0).
interseccion('Villarrica', 'Antequera', 3, 1).
interseccion('Villarrica', 'Artigas', 3, 2).
interseccion('Villarrica', 'J_L_Mallorquin', 3, 3).
interseccion('Villarrica', 'Mcal_Estigarribia', 3, 4).
interseccion('Villarrica', 'C_A_Lopez', 3, 5).
interseccion('Villarrica', 'Lomas_Valentinas', 3, 6).
interseccion('Villarrica', 'Independencia_Nacional', 3, 7).
interseccion('Villarrica', 'Honorio_Gonzalez', 3, 8).
interseccion('Villarrica', 'Av_Irrazabal', 3, 9).
interseccion('Tomas_R_Pereira', 'Av_Francia', 4, 0).
interseccion('Tomas_R_Pereira', 'Antequera', 4, 1).
interseccion('Tomas_R_Pereira', 'Artigas', 4, 2).
interseccion('Tomas_R_Pereira', 'J_L_Mallorquin', 4, 3).
interseccion('Tomas_R_Pereira', 'Mcal_Estigarribia', 4, 4).
interseccion('Tomas_R_Pereira', 'C_A_Lopez', 4, 5).
interseccion('Tomas_R_Pereira', 'Lomas_Valentinas', 4, 6).
interseccion('Tomas_R_Pereira', 'Independencia_Nacional', 4, 7).
interseccion('Tomas_R_Pereira', 'Honorio_Gonzalez', 4, 8).
interseccion('Tomas_R_Pereira', 'Av_Irrazabal', 4, 9).
interseccion('14_de_Mayo', 'Av_Francia', 5, 0).
interseccion('14_de_Mayo', 'Antequera', 5, 1).
interseccion('14_de_Mayo', 'Artigas', 5, 2).
interseccion('14_de_Mayo', 'J_L_Mallorquin', 5, 3).
interseccion('14_de_Mayo', 'Mcal_Estigarribia', 5, 4).
interseccion('14_de_Mayo', 'C_A_Lopez', 5, 5).
interseccion('14_de_Mayo', 'Lomas_Valentinas', 5, 6).
interseccion('14_de_Mayo', 'Independencia_Nacional', 5, 7).
interseccion('14_de_Mayo', 'Honorio_Gonzalez', 5, 8).
interseccion('14_de_Mayo', 'Av_Irrazabal', 5, 9).
interseccion('Cerro_Cora', 'Av_Francia', 6, 0).
interseccion('Cerro_Cora', 'Antequera', 6, 1).
interseccion('Cerro_Cora', 'Artigas', 6, 2).
interseccion('Cerro_Cora', 'J_L_Mallorquin', 6, 3).
interseccion('Cerro_Cora', 'Mcal_Estigarribia', 6, 4).
interseccion('Cerro_Cora', 'C_A_Lopez', 6, 5).
interseccion('Cerro_Cora', 'Lomas_Valentinas', 6, 6).
interseccion('Cerro_Cora', 'Independencia_Nacional', 6, 7).
interseccion('Cerro_Cora', 'Honorio_Gonzalez', 6, 8).
interseccion('Cerro_Cora', 'Av_Irrazabal', 6, 9).
interseccion('M_Wiessen', 'Av_Francia', 7, 0).
interseccion('M_Wiessen', 'Antequera', 7, 1).
interseccion('M_Wiessen', 'Artigas', 7, 2).
interseccion('M_Wiessen', 'J_L_Mallorquin', 7, 3).
interseccion('M_Wiessen', 'Mcal_Estigarribia', 7, 4).
interseccion('M_Wiessen', 'C_A_Lopez', 7, 5).
interseccion('M_Wiessen', 'Lomas_Valentinas', 7, 6).
interseccion('M_Wiessen', 'Independencia_Nacional', 7, 7).
interseccion('M_Wiessen', 'Honorio_Gonzalez', 7, 8).
interseccion('M_Wiessen', 'Av_Irrazabal', 7, 9).
interseccion('Curupayty', 'Av_Francia', 8, 0).
interseccion('Curupayty', 'Antequera', 8, 1).
interseccion('Curupayty', 'Artigas', 8, 2).
interseccion('Curupayty', 'J_L_Mallorquin', 8, 3).
interseccion('Curupayty', 'Mcal_Estigarribia', 8, 4).
interseccion('Curupayty', 'C_A_Lopez', 8, 5).
interseccion('Curupayty', 'Lomas_Valentinas', 8, 6).
interseccion('Curupayty', 'Independencia_Nacional', 8, 7).
interseccion('Curupayty', 'Honorio_Gonzalez', 8, 8).
interseccion('Curupayty', 'Av_Irrazabal', 8, 9).
interseccion('Padre_Kreusser', 'Av_Francia', 9, 0).
interseccion('Padre_Kreusser', 'Antequera', 9, 1).
interseccion('Padre_Kreusser', 'Artigas', 9, 2).
interseccion('Padre_Kreusser', 'J_L_Mallorquin', 9, 3).
interseccion('Padre_Kreusser', 'Mcal_Estigarribia', 9, 4).
interseccion('Padre_Kreusser', 'C_A_Lopez', 9, 5).
interseccion('Padre_Kreusser', 'Lomas_Valentinas', 9, 6).
interseccion('Padre_Kreusser', 'Independencia_Nacional', 9, 7).
interseccion('Padre_Kreusser', 'Honorio_Gonzalez', 9, 8).
interseccion('Padre_Kreusser', 'Av_Irrazabal', 9, 9).

% conductor(ID, Nombre, Calle1, Calle2, Estado)
conductor(c1, 'Juan', 'Padre_Kreusser', 'Antequera', ocupado).
conductor(c2, 'Maria', 'Curupayty', 'Independencia_Nacional', disponible).
conductor(c3, 'Pedro', 'Cerro_Cora', 'Antequera', disponible).
conductor(c4, 'Sandra', 'Villarrica', 'Antequera', disponible).

% pasajero(ID, Nombre, Calle1, Calle2)
pasajero(p1, 'Ana', 'Tomas_R_Pereira', 'Independencia_Nacional').
pasajero(p2, 'Luis', 'Padre_Kreusser', 'J_L_Mallorquin').
pasajero(p3, 'Carla', 'Constitucion_Nacional', 'J_L_Mallorquin').

%precio_km(Precio).
precio_km(5000).



distancia_interseccion(C1a, C2a, C1b, C2b, Distancia):-
    interseccion(C1a, C2a, X_1, Y_1),
	interseccion(C1b, C2b, X_2, Y_2),
	Diff1 is X_1 - X_2,
	Diff2 is Y_1 - Y_2,
	Pot1 is Diff1*Diff1,
    Pot2 is Diff2*Diff2,
    Suma is Pot1 + Pot2,
    Distancia is sqrt(Suma).

distancia_conductor_destino(ConductorID, Calle1D, Calle2D, D):-
    conductor(ConductorID, _, Calle1Or, Calle2Or, disponible),
    distancia_interseccion(Calle1Or, Calle2Or, Calle1D, Calle2D, Distancia),
    D = Distancia.
    
conductor_mas_cercano(Calle1, Calle2, ConductorID, Nombre, Distancia):-
    lista_conductores(Calle1, Calle2, Lista),!,
    minimo(Lista, (ConductorID, Distancia, Nombre)).
    
   

lista_conductores(Calle1, Calle2, Lista):-
    lista_conductores_cercanos_aux(Calle1, Calle2, [], Lista).
    
lista_conductores_cercanos_aux(Calle1, Calle2, Aux, Lista):-
    conductor(ConductorID, Nombre, _, _, disponible),
    distancia_conductor_destino(ConductorID, Calle1, Calle2, D),
    \+ member((ConductorID, _, _), Aux),
    agregar_elemento((ConductorID, D, Nombre), Aux, R1),
    lista_conductores_cercanos_aux(Calle1, Calle2, R1, Lista).
    
lista_conductores_cercanos_aux(_, _, Lista, Lista).

agregar_elemento(X, [], [X]).

agregar_elemento(X, [H|T], [H|R]):-
    agregar_elemento(X, T, R).

minimo([(ID, Distancia, Nombre)], (ID, Distancia, Nombre)).

minimo([(ID, Distancia, Nombre)|T], Min):-
    minimo(T, (_, Distancia2, _)),
    Distancia=<Distancia2,
    Min = (ID, Distancia, Nombre).

minimo([(_, Distancia, _)|T], Min):-
    minimo(T, (ID2, Distancia2, Nombre2)),
    Distancia>=Distancia2,
    Min = (ID2, Distancia2, Nombre2).

asignar_viaje(PasajeroID,ConductorID):-
    pasajero(PasajeroID, _, Calle1Destino, Calle2Destino),
    conductor_mas_cercano(Calle1Destino, Calle2Destino, ConductorID, Nombre, Distancia),!,
	cambiar_estado_conductor(ConductorID).

%cambiar_estado_conductor(ConductorId).
cambiar_estado_conductor(ConductorId):-
    conductor(ConductorId, Nombre, Calle1, Calle2, disponible),
    retract(conductor(ConductorId, Nombre, Calle1, Calle2, disponible)),
    assertz(conductor(ConductorId, Nombre, Calle1, Calle2, ocupado)).

cambiar_estado_conductor(ConductorId):-
    conductor(ConductorId, Nombre, Calle1, Calle2, ocupado),
    retract(conductor(ConductorId, Nombre, Calle1, Calle2, ocupado)),
    assertz(conductor(ConductorId, Nombre, Calle1, Calle2, disponible)).
